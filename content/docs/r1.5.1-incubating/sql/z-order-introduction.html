

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>3. Z-order introduction &mdash; Kyuubi 1.5.1-incubating documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. Z-order Benchmark" href="z-order-benchmark.html" />
    <link rel="prev" title="2. Auxiliary SQL Functions for Spark SQL" href="functions.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Kyuubi
          

          
            
            <img src="../_static/kyuubi_logo_gray.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Usage Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/index.html">Deploying Kyuubi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/index.html">Client Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../integrations/index.html">Integrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monitor/index.html">Monitoring</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">SQL References</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="rules.html">1. Auxiliary SQL extension for Spark SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="functions.html">2. Auxiliary SQL Functions for Spark SQL</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3. Z-order introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">3.1. Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#supported-table-format">3.1.1. Supported table format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#supported-column-data-type">3.1.2. Supported column data type</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-use">3.2. How to use</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#optimize-history-data">3.2.1. Optimize history data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optimize-incremental-data">3.2.2. Optimize incremental data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="z-order-benchmark.html">4. Z-order Benchmark</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Kyuubi Insider</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../develop_tools/index.html">Develop Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Community</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index.html">Appendixes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kyuubi</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">SQL References</a> &raquo;</li>
        
      <li><span class="section-number">3. </span>Z-order introduction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/sql/z-order-introduction.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <!--
 - Licensed to the Apache Software Foundation (ASF) under one or more
 - contributor license agreements.  See the NOTICE file distributed with
 - this work for additional information regarding copyright ownership.
 - The ASF licenses this file to You under the Apache License, Version 2.0
 - (the "License"); you may not use this file except in compliance with
 - the License.  You may obtain a copy of the License at
 -
 -   http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
 --><div align=center><p><img alt="../_images/kyuubi_logo.png" src="../_images/kyuubi_logo.png" /></p>
</div><div class="section" id="z-order-introduction">
<h1><span class="section-number">3. </span>Z-order introduction<a class="headerlink" href="#z-order-introduction" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2><span class="section-number">3.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The following picture shows the workflow of z-order.</p>
<p><img alt="../_images/zorder-workflow.png" src="../_images/zorder-workflow.png" /></p>
<p>It contains three parties:</p>
<ul>
<li><p>Upstream</p>
<p>Due to the extra sort, the upstream job will run a little slower than before</p>
</li>
<li><p>Table</p>
<p>Z-order has the good data clustering, so the compression ratio can be improved</p>
</li>
<li><p>Downstream</p>
<p>Improve the downstream read performance benefit from data skipping. Since the parquet and orc file support collect data statistic automatically when you write data e.g. minimum and maximum values, the good data clustering let the pushed down filter more efficient</p>
</li>
</ul>
<div class="section" id="supported-table-format">
<h3><span class="section-number">3.1.1. </span>Supported table format<a class="headerlink" href="#supported-table-format" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th>Table Format</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr>
<td>parquet</td>
<td>Y</td>
</tr>
<tr>
<td>orc</td>
<td>Y</td>
</tr>
<tr>
<td>json</td>
<td>N</td>
</tr>
<tr>
<td>csv</td>
<td>N</td>
</tr>
<tr>
<td>text</td>
<td>N</td>
</tr>
</tbody>
</table></div>
<div class="section" id="supported-column-data-type">
<h3><span class="section-number">3.1.2. </span>Supported column data type<a class="headerlink" href="#supported-column-data-type" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<thead>
<tr>
<th>Column Data Type</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr>
<td>byte</td>
<td>Y</td>
</tr>
<tr>
<td>short</td>
<td>Y</td>
</tr>
<tr>
<td>int</td>
<td>Y</td>
</tr>
<tr>
<td>long</td>
<td>Y</td>
</tr>
<tr>
<td>float</td>
<td>Y</td>
</tr>
<tr>
<td>double</td>
<td>Y</td>
</tr>
<tr>
<td>boolean</td>
<td>Y</td>
</tr>
<tr>
<td>string</td>
<td>Y</td>
</tr>
<tr>
<td>decimal</td>
<td>Y</td>
</tr>
<tr>
<td>date</td>
<td>Y</td>
</tr>
<tr>
<td>timestamp</td>
<td>Y</td>
</tr>
<tr>
<td>array</td>
<td>N</td>
</tr>
<tr>
<td>map</td>
<td>N</td>
</tr>
<tr>
<td>struct</td>
<td>N</td>
</tr>
<tr>
<td>udt</td>
<td>N</td>
</tr>
</tbody>
</table></div>
</div>
<div class="section" id="how-to-use">
<h2><span class="section-number">3.2. </span>How to use<a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>This feature is inside Kyuubi extension, so you should apply the extension to Spark by following steps.</p>
<ul class="simple">
<li><p>add extension jar: <code class="docutils literal notranslate"><span class="pre">copy</span> <span class="pre">$KYUUBI_HOME/extension/kyuubi-extension-spark-3-1*</span> <span class="pre">$SPARK_HOME/jars/</span></code></p></li>
<li><p>add config into <code class="docutils literal notranslate"><span class="pre">spark-defaults.conf</span></code>: <code class="docutils literal notranslate"><span class="pre">spark.sql.extensions=org.apache.kyuubi.sql.KyuubiSparkSQLExtension</span></code></p></li>
</ul>
<p>Due to the extension, z-order only works with Spark-3.1 and higher version.</p>
<div class="section" id="optimize-history-data">
<h3><span class="section-number">3.2.1. </span>Optimize history data<a class="headerlink" href="#optimize-history-data" title="Permalink to this headline">¶</a></h3>
<p>If you want to optimize the history data of a table, the <code class="docutils literal notranslate"><span class="pre">OPTIMIZE</span> <span class="pre">...</span></code> syntax is good to go. Due to Spark SQL doesn’t support read and overwrite same datasource table, the syntax can only support to optimize Hive table.</p>
<div class="section" id="syntax">
<h4>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">OPTIMIZE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="p">[</span><span class="k">WHERE</span><span class="w"> </span><span class="n">predicate</span><span class="p">]</span><span class="w"> </span><span class="n">ZORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">col_name1</span><span class="w"> </span><span class="p">[,</span><span class="w"> </span><span class="p">...]</span><span class="w"></span>
</pre></div>
</div>
<p>Note that, the <code class="docutils literal notranslate"><span class="pre">predicate</span></code> only supports partition spec.</p>
</div>
<div class="section" id="examples">
<h4>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">OPTIMIZE</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">ZORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">c3</span><span class="p">;</span><span class="w"></span>

<span class="n">OPTIMIZE</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">ZORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">;</span><span class="w"></span>

<span class="n">OPTIMIZE</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;2021-12-01&#39;</span><span class="w"> </span><span class="n">ZORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="optimize-incremental-data">
<h3><span class="section-number">3.2.2. </span>Optimize incremental data<a class="headerlink" href="#optimize-incremental-data" title="Permalink to this headline">¶</a></h3>
<p>Kyuubi supports optimize a table automatically for incremental data. e.g., time partitioned table. The only things you need to do is adding Kyuubi properties into the target table properties:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">TBLPROPERTIES</span><span class="p">(</span><span class="s1">&#39;kyuubi.zorder.enabled&#39;</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span><span class="s1">&#39;kyuubi.zorder.cols&#39;</span><span class="o">=</span><span class="s1">&#39;c1,c2&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>the key <code class="docutils literal notranslate"><span class="pre">kyuubi.zorder.enabled</span></code> decide if the table allows Kyuubi to optimize by z-order.</p></li>
<li><p>the key <code class="docutils literal notranslate"><span class="pre">kyuubi.zorder.cols</span></code> decide which columns are used to optimize by z-order.</p></li>
</ul>
<p>Kyuubi will detect the properties and optimize SQL using z-order during SQL compilation, so you can enjoy z-order with all writing table command like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">PARTITION</span><span class="p">()</span><span class="w"> </span><span class="p">...;</span><span class="w"></span>

<span class="k">INSERT</span><span class="w"> </span><span class="n">OVERWRITE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="n">PARTITION</span><span class="p">()</span><span class="w"> </span><span class="p">...;</span><span class="w"></span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="p">...;</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="z-order-benchmark.html" class="btn btn-neutral float-right" title="4. Z-order Benchmark" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="functions.html" class="btn btn-neutral float-left" title="2. Auxiliary SQL Functions for Spark SQL" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 
Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to You under the Apache License, Version 2.0
(the &#34;License&#34;); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>